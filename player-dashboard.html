<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GameBridge | Player Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root { --primary-bg: #0d1b2a; --accent-teal: #00f5d4; --accent-purple: #a855f7; }
body { font-family: 'Inter', sans-serif; background: radial-gradient(circle at 10% 10%, #1a1a2e 0%, #0f3460 30%, #533483 70%, #16213e 100%); color: white; min-height: 100vh; overflow-x: hidden; position: relative; }
.grid-layer { position: fixed; bottom: -10%; left: -10%; width: 120%; height: 60%; background-image: linear-gradient(to right, rgba(0,245,212,0.05) 1px, transparent 1px), linear-gradient(to bottom, rgba(0,245,212,0.05) 1px, transparent 1px); background-size: 50px 50px; transform: perspective(500px) rotateX(60deg); z-index: 0; }
.g-logo { display: flex; align-items: center; justify-content: center; font-weight: 900; border-radius: 8px; background: linear-gradient(135deg,#bf953f 0%,#fcf6ba 45%,#b38728 50%,#fbf5b7 55%,#aa771c 100%); border:1px solid rgba(255,215,0,0.3); box-shadow:0 0 15px rgba(191,149,63,0.4); color:#1a1a2e; user-select:none; }
.g-logo::after { content: 'G'; }
.glass-panel { background: rgba(255,255,255,0.03); backdrop-filter: blur(20px); border:1px solid rgba(255,255,255,0.1); border-radius:24px; }
.game-card { background: rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.05); transition: all 0.3s ease; }
.game-card:hover { border-color: var(--accent-teal); transform: translateY(-2px); }
.btn-play { background: #00bcd4; transition: all 0.3s ease; }
.btn-play:hover { background: #00e5ff; box-shadow:0 0 20px rgba(0,188,212,0.4); }
.btn-install { background: rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); transition: all 0.3s ease; }
.btn-install:hover { background: rgba(255,255,255,0.1); }
.custom-scrollbar::-webkit-scrollbar { width:6px; }
.custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius:10px; }
.skeleton { background: linear-gradient(90deg, rgba(255,255,255,0.05) 25%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.05) 75%); background-size: 200% 100%; animation: loading 1.5s infinite; }
@keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
</style>

    <link rel="manifest" href="manifest.json">
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js');
  }
</script>

    
</head>
<body class="p-4 md:p-8 flex justify-center">

<div class="grid-layer"></div>

<main class="relative z-10 w-full max-w-2xl glass-panel shadow-2xl overflow-hidden flex flex-col h-[90vh]">
    <header class="p-6 border-b border-white/10 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div class="g-logo w-8 h-8 text-sm"></div>
            <h1 class="text-xl font-bold tracking-tight">GameBridge</h1>
        </div>
        <nav class="flex gap-6 text-sm font-semibold">
            <button id="navLibrary" class="text-white border-b-2 border-cyan-400 pb-1">LIBRARY</button>
            <button id="navOffers" class="text-gray-400 hover:text-white transition-colors">OFFERS</button>
            <button id="navHistory" class="text-gray-400 hover:text-white transition-colors">HISTORY</button>
        </nav>
        <button id="logoutBtn" class="w-8 h-8 rounded-full border border-white/20 flex items-center justify-center hover:bg-white/10">üë§</button>
    </header>

    <div id="viewTitle" class="p-6">
        <h2 class="text-2xl font-bold mb-2">Discover & Play</h2>
        <p class="text-gray-400 text-sm">Access verified game tasks and earn rewards.</p>
    </div>

    <div id="gamesContainer" class="flex-1 overflow-y-auto p-6 pt-0 custom-scrollbar space-y-4">
        <div id="loader" class="space-y-4">
            <div class="game-card p-4 rounded-2xl h-32 skeleton"></div>
            <div class="game-card p-4 rounded-2xl h-32 skeleton"></div>
        </div>
    </div>

    <footer class="p-4 text-center border-t border-white/10">
        <p class="text-[10px] text-gray-500 uppercase tracking-widest">Performance Hub ‚Ä¢ Secure Connection Active</p>
    </footer>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { 
    getFirestore, collection, onSnapshot, query, orderBy, where, 
    addDoc, serverTimestamp, doc, getDoc 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyCLd4MLONU_5OFie6WN2XmXmlMyfuJ5_8I",
    authDomain: "gamebridge-f4789.firebaseapp.com",
    projectId: "gamebridge-f4789",
    storageBucket: "gamebridge-f4789.firebasestorage.app",
    messagingSenderId: "562553872482",
    appId: "1:562553872482:web:02b34e7bc1b7a25af8f13b"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

onAuthStateChanged(auth, user => { if (!user) window.location.href = 'index.html'; });

const gamesContainer = document.getElementById('gamesContainer');

// --- SECURE MONETIZATION LOGIC (CPA) ---

window.handleLaunchDemo = async (gameId, url) => {
    if(!auth.currentUser) return;
    
    // CPA tracking ID attachment
    const trackingUrl = `${url}${url.includes('?') ? '&' : '?'}click_id=${auth.currentUser.uid}`;

    if(confirm("Launch this task? Tracking active.")) {
        try {
            const gSnap = await getDoc(doc(db, "games", gameId));
            const payout = gSnap.exists() ? gSnap.data().adPayout : 0;

            await addDoc(collection(db, "events"), {
                userId: auth.currentUser.uid,
                userEmail: auth.currentUser.email,
                gameName: gSnap.data().title || "Unknown Game",
                type: "ad_view",
                value: Number(payout) || 0,
                timestamp: serverTimestamp()
            });
            window.open(trackingUrl, "_blank");
        } catch(err) { console.error("Error:", err); }
    }
};

window.handleInstall = async (gameId, url) => {
    if(!auth.currentUser) return;
    const trackingUrl = `${url}${url.includes('?') ? '&' : '?'}subid=${auth.currentUser.uid}`;

    if(confirm("Redirecting to app. Reach required level to verify.")) {
        try {
            const gSnap = await getDoc(doc(db, "games", gameId));
            const payout = gSnap.exists() ? gSnap.data().installPayout : 0;

            await addDoc(collection(db, "events"), {
                userId: auth.currentUser.uid,
                userEmail: auth.currentUser.email,
                gameName: gSnap.data().title || "Unknown Game",
                type: "install",
                value: Number(payout) || 0,
                timestamp: serverTimestamp()
            });
            window.open(trackingUrl, "_blank");
        } catch(err) { console.error("Error:", err); }
    }
};

// --- VIEW NAVIGATION ---

const loadLibrary = () => {
    document.getElementById('viewTitle').innerHTML = `<h2 class="text-2xl font-bold mb-2">Discover & Play</h2><p class="text-gray-400 text-sm">Direct game tasks with instant logging.</p>`;
    updateNav('navLibrary');
    
    const q = query(collection(db, "games"), where("status","==","active"), orderBy("createdAt","desc"));
    onSnapshot(q, snap => {
        gamesContainer.innerHTML = "";
        snap.forEach(d => {
            const g = d.data();
            gamesContainer.innerHTML += `
            <div class="game-card p-4 rounded-2xl border-l-4 border-cyan-500/30">
                <div class="flex gap-4 mb-4">
                    <div class="w-16 h-16 rounded-xl bg-gray-900 flex items-center justify-center text-3xl">üïπÔ∏è</div>
                    <div class="flex-1">
                        <h3 class="text-lg font-bold text-white">${g.title}</h3>
                        <p class="text-[10px] text-cyan-400 uppercase font-black tracking-widest">${g.studio}</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="handleLaunchDemo('${d.id}', '${g.url}')" class="btn-play py-3 rounded-xl font-bold text-xs uppercase text-white">‚ñ∂ Play</button>
                    <button onclick="handleInstall('${d.id}', '${g.url}')" class="btn-install py-3 rounded-xl font-bold text-xs uppercase text-white">üì≤ Task</button>
                </div>
            </div>`;
        });
    });
};

const loadOffers = () => {
    document.getElementById('viewTitle').innerHTML = `<h2 class="text-2xl font-bold mb-2">Offerwall</h2><p class="text-gray-400 text-sm">Complete high-paying offers from our partners.</p>`;
    updateNav('navOffers');
    
    // REPLACE 'YOUR_OFFERWALL_URL_HERE' with your Lootably/Revlum link once you have it.
    // Important: Keep the part after the slash as auth.currentUser.uid
    const wallUrl = `YOUR_OFFERWALL_URL_HERE/${auth.currentUser.uid}`;
    
    gamesContainer.innerHTML = `
        <div class="w-full h-full min-h-[500px] rounded-2xl overflow-hidden bg-black/20 border border-white/5">
            <iframe src="${wallUrl}" style="width:100%; height:100%; min-height:600px; border:none;"></iframe>
        </div>
    `;
};

const loadHistory = () => {
    document.getElementById('viewTitle').innerHTML = `<h2 class="text-2xl font-bold mb-2">My Activity</h2><p class="text-gray-400 text-sm">Recently logged tasks and earnings.</p>`;
    updateNav('navHistory');

    const q = query(collection(db, "events"), where("userId", "==", auth.currentUser.uid), orderBy("timestamp", "desc"));
    onSnapshot(q, snap => {
        gamesContainer.innerHTML = "";
        if(snap.empty) gamesContainer.innerHTML = `<p class="text-center text-gray-500 py-10">No history found.</p>`;
        snap.forEach(d => {
            const e = d.data();
            gamesContainer.innerHTML += `
            <div class="p-4 bg-white/5 rounded-xl border border-white/5 flex justify-between items-center">
                <div>
                    <p class="text-xs font-bold">${e.gameName || 'Task'}</p>
                    <p class="text-[10px] text-gray-500 uppercase">${e.type}</p>
                </div>
                <p class="text-emerald-400 font-mono text-[10px]">VERIFIED</p>
            </div>`;
        });
    });
};

const updateNav = (activeId) => {
    ['navLibrary', 'navOffers', 'navHistory'].forEach(id => {
        document.getElementById(id).className = (id === activeId) 
            ? "text-white border-b-2 border-cyan-400 pb-1" 
            : "text-gray-400 hover:text-white transition-colors";
    });
};

document.getElementById('navLibrary').addEventListener('click', loadLibrary);
document.getElementById('navOffers').addEventListener('click', loadOffers);
document.getElementById('navHistory').addEventListener('click', loadHistory);
document.getElementById('logoutBtn').addEventListener("click", () => signOut(auth).then(() => window.location.href = "index.html"));

loadLibrary();

</script>
</body>
</html>


